---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostLayout from "../../layouts/PostLayout.astro";
import Button from "../../components/UI/Button.astro";
import { getCollection } from "astro:content";
import { formatDate } from "../../utils/dateUtils";

// Generate static paths for all routes
export async function getStaticPaths() {
  try {
    const routeEntries = await getCollection("routes", ({ data }) => {
      return import.meta.env.PROD ? !data.draft : true;
    });

    return routeEntries.map(entry => ({
      params: { slug: entry.slug },
      props: { entry },
    }));
  } catch (error) {
    // If the collection doesn't exist yet, return an empty array
    return [];
  }
}

// Get the route data
const { entry } = Astro.props;
const { Content } = await entry.render();

// Format the date for display
const formattedDate = formatDate(entry.data.date);

// Find related routes from the same category (if available)
let relatedRoutes = [];
if (entry.data.category) {
  try {
    const allRoutes = await getCollection("routes", ({ data }) => {
      return import.meta.env.PROD ? !data.draft : true;
    });
    
    relatedRoutes = allRoutes
      .filter(route => 
        route.data.category === entry.data.category && route.slug !== entry.slug
      )
      .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
      .slice(0, 3);
  } catch (error) {
    console.log("Error fetching related routes");
  }
}
---

<BaseLayout
  title={`${entry.data.title} - サイクリングルート - ギークのためのサイクリング`}
  description={entry.data.summary || `Listen to "${entry.data.title}" route and explore cycling adventures.`}
  image={entry.data.image ? { url: entry.data.image, alt: entry.data.title } : undefined}
  type="article"
>
  <PostLayout
    title={entry.data.title}
    description={entry.data.summary}
    image={entry.data.image ? { url: entry.data.image, alt: entry.data.title } : undefined}
    date={entry.data.date}
    tags={entry.data.tags}
    type="route"
  >
    <!-- Route Details -->
    <div class="bg-gray-50 rounded-lg p-6 mb-8">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>          
          {
            entry.data.category && (
              <div class="mb-4">
                <h3 class="text-lg font-bold mb-2">Category</h3>
                <p class="flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                  </svg>
                  {entry.data.category}
                </p>
              </div>
            )
          }
        </div>

        <div>
          {
            entry.data.prefecture && (
              <div class="mb-4">
                <h3 class="text-lg font-bold mb-2">Prefecture</h3>
                <p class="flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 7.292M6 21h12a2 2 0 002-2v-7a2 2 0 00-2-2H6a2 2 0 00-2 2v7a2 2 0 002 2z" />
                  </svg>
                  {entry.data.prefecture}
                </p>
              </div>
            )
          }
        </div>
      </div>
    </div>
        
    <!-- Route Content -->
    <article class="prose prose-lg max-w-none prose-headings:text-gray-900 prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-h4:text-lg prose-p:text-gray-700 prose-li:text-gray-700 prose-strong:text-gray-900 prose-a:text-primary-600 hover:prose-a:text-primary-700">
      <Content />
    </article>
    
    <!-- Related Routes -->
    {
      relatedRoutes.length > 0 && (
        <div class="mt-12">
          <h2 class="text-2xl font-bold mb-6">More From This Category</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {relatedRoutes.map(route => (
              <a href={`/routes/${route.slug}`} class="block bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors">
                <h3 class="font-bold mb-2">{route.data.title}</h3>
                <p class="text-sm text-gray-600 mb-2">{formatDate(route.data.date)}</p>
                <p class="text-primary-600 text-sm font-medium">Listen/Watch →</p>
              </a>
            ))}
          </div>
        </div>
      )
    }
    
    <!-- Action Buttons -->
    <div class="mt-12 flex flex-wrap gap-4">
      <Button href="/routes" variant="outline">
        Back to All Routes
      </Button>
      
      {
        entry.data.category && (
          <Button href={`/routes?category=${encodeURIComponent(entry.data.category)}`} variant="outline">
            View All in This Category
          </Button>
        )
      }
    </div>
  </PostLayout>
</BaseLayout>